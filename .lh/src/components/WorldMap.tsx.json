{
    "sourceFile": "src/components/WorldMap.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1760434895630,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1760439886690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,22 +53,17 @@\n   streets: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' // Street labels\r\n };\r\n \r\n // Display saved zones as polygons\r\n-const ZonesDisplay = ({ zones }: { zones: Zone[] }) => {\r\n-  console.log('üó∫Ô∏è ZonesDisplay rendering with zones:', zones.length, zones);\r\n-  \r\n+const ZonesDisplay = React.memo(({ zones }: { zones: Zone[] }) => {\r\n   return (\r\n     <React.Fragment>\r\n       {zones.map((zone) => {\r\n         // Only render zones with coordinates\r\n         if (!zone.coordinates || zone.coordinates.length === 0) {\r\n-          console.log('‚ö†Ô∏è Skipping zone with no coordinates:', zone.name);\r\n           return null;\r\n         }\r\n         \r\n-        console.log(`üé® Rendering zone: ${zone.name} (${zone.color}) with ${zone.coordinates.length} coordinates`);\r\n-        \r\n         return (\r\n           <Polygon \r\n             key={zone.id} \r\n             positions={zone.coordinates}\r\n@@ -81,9 +76,9 @@\n         );\r\n       })}\r\n     </React.Fragment>\r\n   );\r\n-};\r\n+});\r\n \r\n // Separate component to use the useMap hook\r\n const PolygonDrawingControl = ({ \r\n   onZoneCreated, \r\n@@ -199,13 +194,14 @@\n   mapId,\r\n   onZoneCreated\r\n }) => {\r\n   const mapRef = useRef<L.Map | null>(null);\r\n-  const [zones, setZones] = useState<Zone[]>(initialZones);\r\n+  const [zones, setZones] = useState<Zone[]>([]);\r\n   const [isDrawing, setIsDrawing] = useState<boolean>(false);\r\n   const [currentZoneDetails, setCurrentZoneDetails] = useState<{ name: string; color: string }>({ name: \"\", color: \"#3388ff\" });\r\n   const [mapInfo, setMapInfo] = useState<{ code: string; title: string } | null>(null);\r\n   const [isSavingZone, setIsSavingZone] = useState<boolean>(false);\r\n+  const initialZonesLoadedRef = useRef(false);\r\n   \r\n   // Layer management state\r\n   const [currentLayers, setCurrentLayers] = useState({\r\n     baseMap: 'standard',\r\n@@ -242,53 +238,64 @@\n       });\r\n     }\r\n   }, [mapId, mapInfo, generateMapCode]);\r\n \r\n-  // Initialize zones when initialZones prop changes\r\n+  // Load zones from database or use initialZones (run only once)\r\n   useEffect(() => {\r\n-    setZones(initialZones);\r\n-  }, [initialZones]);\r\n-\r\n-  // Load zones from database when mapId changes\r\n-  useEffect(() => {\r\n     const loadZones = async () => {\r\n       console.log('üîç WorldMap loadZones effect triggered, mapId:', mapId);\r\n       \r\n+      // Prevent loading if already loaded\r\n+      if (initialZonesLoadedRef.current) {\r\n+        console.log('‚è≠Ô∏è Zones already loaded, skipping');\r\n+        return;\r\n+      }\r\n+      \r\n       if (!mapId) {\r\n-        console.log('‚ùå No mapId provided, skipping zone loading');\r\n+        // Use initialZones if provided, otherwise empty array\r\n+        if (initialZones && initialZones.length > 0) {\r\n+          console.log('üì• Using initialZones:', initialZones.length);\r\n+          setZones(initialZones);\r\n+          initialZonesLoadedRef.current = true;\r\n+        } else {\r\n+          console.log('‚ùå No mapId provided, no zones to load');\r\n+        }\r\n         return;\r\n       }\r\n       \r\n       try {\r\n         console.log(`üåê Loading zones for map ID: ${mapId}`);\r\n-        const response = await fetch(`/api/db/tables/zones?map_id=${mapId}`);\r\n+        const response = await fetch(`/api/map/${mapId}/zones`);\r\n         const data = await response.json();\r\n         \r\n         console.log('üìä Zones API response:', data);\r\n         \r\n-        if (data.success && Array.isArray(data.records)) {\r\n-          // Parse coordinates from JSON strings\r\n-          const zonesWithParsedCoords = data.records.map((zone: Zone & { coordinates: string | [number, number][] }) => ({\r\n+        if (data.success && Array.isArray(data.zones)) {\r\n+          // Parse coordinates from JSON strings if needed\r\n+          const zonesWithParsedCoords = data.zones.map((zone: Zone & { coordinates: string | [number, number][] }) => ({\r\n             ...zone,\r\n             coordinates: typeof zone.coordinates === 'string' \r\n               ? JSON.parse(zone.coordinates) \r\n               : zone.coordinates\r\n           }));\r\n           \r\n           setZones(zonesWithParsedCoords);\r\n-          console.log(`‚úÖ Loaded ${zonesWithParsedCoords.length} zones for map ${mapId}:`, zonesWithParsedCoords);\r\n+          initialZonesLoadedRef.current = true;\r\n+          console.log(`‚úÖ Loaded ${zonesWithParsedCoords.length} zones for map ${mapId}`);\r\n         } else {\r\n           console.log('‚ö†Ô∏è No zones found for this map');\r\n           setZones([]);\r\n+          initialZonesLoadedRef.current = true;\r\n         }\r\n       } catch (err) {\r\n         console.error('‚ùå Failed to load zones:', err);\r\n         setZones([]);\r\n       }\r\n     };\r\n     \r\n     loadZones();\r\n-  }, [mapId]);\r\n+    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n+  }, [mapId]); // Only depend on mapId, not initialZones to prevent infinite loop\r\n \r\n   // Load map information when mapId changes\r\n   useEffect(() => {\r\n     const loadMapInfo = async () => {\r\n@@ -371,31 +378,30 @@\n     try {\r\n       // Save zone to database first with proper customer linking\r\n       if (mapId) {\r\n         // First get the map owner to set customer_id\r\n-        const mapResponse = await fetch(`/api/db/tables/map/${mapId}`);\r\n+        const mapResponse = await fetch(`/api/map/${mapId}`);\r\n         const mapData = await mapResponse.json();\r\n         \r\n         let customer_id = null;\r\n-        if (mapData.success && mapData.record) {\r\n-          customer_id = mapData.record.customer_id;\r\n+        if (mapData.success && mapData.map) {\r\n+          customer_id = mapData.map.customer_id;\r\n         }\r\n         \r\n         console.log('üè™ Saving zone with customer_id:', customer_id);\r\n         \r\n         // Save to zones table with customer_id\r\n-        const response = await fetch('/api/db/tables/zones', {\r\n+        const response = await fetch('/api/zone', {\r\n           method: 'POST',\r\n           headers: {\r\n             'Content-Type': 'application/json',\r\n           },\r\n           body: JSON.stringify({\r\n-            id: zoneData.id,\r\n             map_id: mapId,\r\n             customer_id: customer_id,\r\n             name: zoneData.name,\r\n             color: zoneData.color,\r\n-            coordinates: JSON.stringify(zoneData.coordinates)\r\n+            coordinates: zoneData.coordinates\r\n           })\r\n         });\r\n         \r\n         const result = await response.json();\r\n@@ -469,9 +475,9 @@\n     console.log('üóëÔ∏è Deleting zone:', id);\r\n     \r\n     try {\r\n       // Delete from database first\r\n-      const response = await fetch(`/api/db/tables/zones/${id}`, {\r\n+      const response = await fetch(`/api/zone/${id}`, {\r\n         method: 'DELETE'\r\n       });\r\n       \r\n       const result = await response.json();\r\n@@ -512,9 +518,9 @@\n       let errorCount = 0;\r\n \r\n       for (const zone of zones) {\r\n         try {\r\n-          const response = await fetch(`/api/db/tables/zones/${zone.id}`, {\r\n+          const response = await fetch(`/api/zone/${zone.id}`, {\r\n             method: 'PUT',\r\n             headers: {\r\n               'Content-Type': 'application/json',\r\n             },\r\n"
                },
                {
                    "date": 1760440044322,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -511,38 +511,56 @@\n       alert('No zones to save.');\r\n       return;\r\n     }\r\n \r\n+    if (!mapId) {\r\n+      alert('Cannot save zones: Map not saved yet. Please save the map first.');\r\n+      return;\r\n+    }\r\n+\r\n     setIsSavingZone(true);\r\n     try {\r\n+      // First get customer_id from the map\r\n+      const mapResponse = await fetch(`/api/map/${mapId}`);\r\n+      const mapData = await mapResponse.json();\r\n+      \r\n+      let customer_id = null;\r\n+      if (mapData.success && mapData.map) {\r\n+        customer_id = mapData.map.customer_id;\r\n+      }\r\n+\r\n       let successCount = 0;\r\n       let errorCount = 0;\r\n \r\n+      // Try to create zones instead of updating them\r\n       for (const zone of zones) {\r\n         try {\r\n-          const response = await fetch(`/api/zone/${zone.id}`, {\r\n-            method: 'PUT',\r\n+          // Always try to CREATE the zone (POST), backend will handle duplicates\r\n+          const response = await fetch('/api/zone', {\r\n+            method: 'POST',\r\n             headers: {\r\n               'Content-Type': 'application/json',\r\n             },\r\n             body: JSON.stringify({\r\n               name: zone.name,\r\n               color: zone.color,\r\n               coordinates: zone.coordinates,\r\n               map_id: mapId,\r\n+              customer_id: customer_id\r\n             })\r\n           });\r\n \r\n           const result = await response.json();\r\n           if (result.success) {\r\n             successCount++;\r\n+            console.log(`‚úÖ Zone \"${zone.name}\" saved successfully`);\r\n           } else {\r\n             errorCount++;\r\n-            console.error('‚ùå Failed to save zone:', zone.id, result.error);\r\n+            console.error('‚ùå Failed to save zone:', zone.name, result.error);\r\n           }\r\n         } catch (err) {\r\n           errorCount++;\r\n-          console.error('‚ùå Error saving zone:', zone.id, err);\r\n+          console.error('‚ùå Error saving zone:', zone.name, err);\r\n         }\r\n       }\r\n \r\n       // Create a fancy notification instead of alert\r\n"
                },
                {
                    "date": 1761124025414,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,8 @@\n import L from 'leaflet';\r\n import 'leaflet-draw';\r\n import { COUNTRY_COORDINATES } from '../utils/countryCoordinates';\r\n import ZoneControls from './ZoneControls';\r\n-import LayerControls from './LayerControls';\r\n import SaveMapButton from './SaveMapButton';\r\n import './ZoneControls.css';\r\n import { v4 as uuidv4 } from 'uuid';\r\n import type { Zone } from '../types/zones';\r\n@@ -36,24 +35,44 @@\n   highlightedCountry?: string;\r\n   initialZones?: Zone[];\r\n   mapId?: number;\r\n   onZoneCreated?: (zone: Zone) => void;\r\n+  onBoundsChange?: (bounds: { north: number; south: number; east: number; west: number }) => void;\r\n+  initialMapType?: 'road' | 'satellite' | 'hybrid' | 'terrain';\r\n+  onMapTypeChange?: (type: 'road' | 'satellite' | 'hybrid' | 'terrain') => void;\r\n }\r\n \r\n-// Different tile layer URLs\r\n+// Different tile layer URLs - matching Google Maps style\r\n const TILE_LAYERS = {\r\n-  standard: 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',\r\n-  satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n-  terrain: 'https://tiles.stadiamaps.com/tiles/outdoors/{z}/{x}/{y}{r}.png',\r\n-  dark: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png'\r\n+  road: {\r\n+    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n+    attribution: '¬© OpenStreetMap contributors',\r\n+    maxZoom: 19\r\n+  },\r\n+  satellite: {\r\n+    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n+    attribution: '¬© Esri, Maxar, Earthstar Geographics',\r\n+    maxZoom: 19\r\n+  },\r\n+  hybrid: {\r\n+    base: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n+    overlay: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n+    attribution: '¬© Esri, OpenStreetMap contributors',\r\n+    maxZoom: 19\r\n+  },\r\n+  terrain: {\r\n+    url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',\r\n+    attribution: '¬© OpenTopoMap contributors',\r\n+    maxZoom: 17\r\n+  },\r\n+  traffic: {\r\n+    base: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n+    attribution: '¬© OpenStreetMap contributors',\r\n+    maxZoom: 19,\r\n+    note: 'Traffic overlay would require a specific traffic data provider'\r\n+  }\r\n };\r\n \r\n-// Overlay layer URLs\r\n-const OVERLAY_LAYERS = {\r\n-  buildings: 'https://tiles.openstreetmap.org/{z}/{x}/{y}.png', // Buildings overlay - better visibility\r\n-  streets: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' // Street labels\r\n-};\r\n-\r\n // Display saved zones as polygons\r\n const ZonesDisplay = React.memo(({ zones }: { zones: Zone[] }) => {\r\n   return (\r\n     <React.Fragment>\r\n@@ -184,16 +203,51 @@\n   \r\n   return null;\r\n };\r\n \r\n+// Component to track map bounds and notify parent\r\n+const BoundsTracker = ({ onBoundsChange }: { onBoundsChange: (bounds: { north: number; south: number; east: number; west: number }) => void }) => {\r\n+  const map = useMap();\r\n+\r\n+  useEffect(() => {\r\n+    const updateBounds = () => {\r\n+      const bounds = map.getBounds();\r\n+      const boundsObj = {\r\n+        north: bounds.getNorth(),\r\n+        south: bounds.getSouth(),\r\n+        east: bounds.getEast(),\r\n+        west: bounds.getWest()\r\n+      };\r\n+      onBoundsChange(boundsObj);\r\n+    };\r\n+\r\n+    // Update bounds immediately\r\n+    updateBounds();\r\n+\r\n+    // Update bounds when map moves or zooms\r\n+    map.on('moveend', updateBounds);\r\n+    map.on('zoomend', updateBounds);\r\n+\r\n+    return () => {\r\n+      map.off('moveend', updateBounds);\r\n+      map.off('zoomend', updateBounds);\r\n+    };\r\n+  }, [map, onBoundsChange]);\r\n+\r\n+  return null;\r\n+};\r\n+\r\n const WorldMap: React.FC<WorldMapProps> = ({\r\n   lat,\r\n   lng,\r\n   zoom,\r\n   highlightedCountry,\r\n   initialZones = [],\r\n   mapId,\r\n-  onZoneCreated\r\n+  onZoneCreated,\r\n+  onBoundsChange,\r\n+  initialMapType = 'road',\r\n+  onMapTypeChange\r\n }) => {\r\n   const mapRef = useRef<L.Map | null>(null);\r\n   const [zones, setZones] = useState<Zone[]>([]);\r\n   const [isDrawing, setIsDrawing] = useState<boolean>(false);\r\n@@ -201,14 +255,10 @@\n   const [mapInfo, setMapInfo] = useState<{ code: string; title: string } | null>(null);\r\n   const [isSavingZone, setIsSavingZone] = useState<boolean>(false);\r\n   const initialZonesLoadedRef = useRef(false);\r\n   \r\n-  // Layer management state\r\n-  const [currentLayers, setCurrentLayers] = useState({\r\n-    baseMap: 'standard',\r\n-    buildings: false,\r\n-    streets: false\r\n-  });\r\n+  // Layer management state - use initialMapType from props\r\n+  const [currentMapType, setCurrentMapType] = useState<'road' | 'satellite' | 'hybrid' | 'terrain' | 'traffic'>(initialMapType);\r\n   \r\n   // Generate map code for new maps\r\n   const generateMapCode = useCallback((): string => {\r\n     const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\r\n@@ -238,8 +288,13 @@\n       });\r\n     }\r\n   }, [mapId, mapInfo, generateMapCode]);\r\n \r\n+  // Update map type when prop changes\r\n+  useEffect(() => {\r\n+    setCurrentMapType(initialMapType);\r\n+  }, [initialMapType]);\r\n+\r\n   // Load zones from database or use initialZones (run only once)\r\n   useEffect(() => {\r\n     const loadZones = async () => {\r\n       console.log('üîç WorldMap loadZones effect triggered, mapId:', mapId);\r\n@@ -406,10 +461,17 @@\n         \r\n         const result = await response.json();\r\n         if (result.success) {\r\n           console.log('‚úÖ Zone saved successfully:', result);\r\n-          // Zone already added to local state above\r\n           \r\n+          // Update the zone in local state with the ID from database\r\n+          if (result.zone && result.zone.id) {\r\n+            setZones(prev => prev.map(z => \r\n+              z.id === zoneData.id ? { ...z, id: result.zone.id } : z\r\n+            ));\r\n+            console.log(`üîÑ Updated zone ID: ${zoneData.id} ‚Üí ${result.zone.id}`);\r\n+          }\r\n+          \r\n           // Show success message without blocking the UI\r\n           setTimeout(() => {\r\n             const successMsg = document.createElement('div');\r\n             successMsg.innerHTML = `\r\n@@ -473,36 +535,44 @@\n   // Handle deleting a zone\r\n   const handleDeleteZone = useCallback(async (id: string) => {\r\n     console.log('üóëÔ∏è Deleting zone:', id);\r\n     \r\n+    // Always remove from UI immediately for better UX\r\n+    setZones(prev => prev.filter(z => z.id !== id));\r\n+    \r\n     try {\r\n-      // Delete from database first\r\n+      // Delete from database\r\n       const response = await fetch(`/api/zone/${id}`, {\r\n         method: 'DELETE'\r\n       });\r\n       \r\n+      if (!response.ok) {\r\n+        console.warn(`‚ö†Ô∏è Failed to delete zone from database (${response.status}), but removed from UI`);\r\n+        return; // Already removed from UI, no need to alert\r\n+      }\r\n+      \r\n       const result = await response.json();\r\n       if (result.success) {\r\n-        // Remove from local state\r\n-        setZones(prev => prev.filter(z => z.id !== id));\r\n-        console.log('‚úÖ Zone deleted successfully');\r\n+        console.log('‚úÖ Zone deleted from database successfully');\r\n       } else {\r\n-        console.error('‚ùå Failed to delete zone:', result.error);\r\n-        alert('Failed to delete zone: ' + result.error);\r\n+        console.warn('‚ö†Ô∏è Zone deleted from UI but database returned:', result.error);\r\n       }\r\n     } catch (err) {\r\n-      console.error('‚ùå Failed to delete zone:', err);\r\n-      alert('Failed to delete zone. Please try again.');\r\n+      console.warn('‚ö†Ô∏è Zone deleted from UI but database request failed:', err);\r\n+      // Don't show error to user since zone is already removed from UI\r\n     }\r\n   }, []);\r\n \r\n-  // Handle layer changes\r\n-  const handleLayerChange = useCallback((layerType: string, value: string | boolean) => {\r\n-    setCurrentLayers(prev => ({\r\n-      ...prev,\r\n-      [layerType]: value\r\n-    }));\r\n-  }, []);\r\n+  // Handle map type change\r\n+  const handleMapTypeChange = useCallback((mapType: 'road' | 'satellite' | 'hybrid' | 'terrain' | 'traffic') => {\r\n+    console.log('üó∫Ô∏è Changing map type to:', mapType);\r\n+    setCurrentMapType(mapType);\r\n+    \r\n+    // Notify parent component if callback provided\r\n+    if (onMapTypeChange && mapType !== 'traffic') {\r\n+      onMapTypeChange(mapType);\r\n+    }\r\n+  }, [onMapTypeChange]);\r\n \r\n   // Handle saving all zones (manual save)\r\n   const handleSaveAllZones = useCallback(async () => {\r\n     console.log('üíæ Manually saving all zones to database...', zones.length);\r\n@@ -651,49 +721,15 @@\n       setIsSavingZone(false);\r\n     }\r\n   }, [zones, mapId]);\r\n \r\n-  // Handle saving map data\r\n-  const handleSaveMap = useCallback(async () => {\r\n-    console.log('üíæ Saving map data...', mapInfo);\r\n-    \r\n-    if (!mapId || !mapInfo) {\r\n-      alert('No map data to save.');\r\n-      return;\r\n-    }\r\n-\r\n-    try {\r\n-      const response = await fetch(`/api/db/tables/map/${mapId}`, {\r\n-        method: 'PUT',\r\n-        headers: {\r\n-          'Content-Type': 'application/json',\r\n-        },\r\n-        body: JSON.stringify({\r\n-          title: mapInfo.title,\r\n-          code: mapInfo.code,\r\n-        })\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (result.success) {\r\n-        alert('‚úÖ Map saved successfully!');\r\n-      } else {\r\n-        console.error('‚ùå Failed to save map:', result.error);\r\n-        alert('Failed to save map: ' + result.error);\r\n-      }\r\n-    } catch (err) {\r\n-      console.error('‚ùå Error saving map:', err);\r\n-      alert('Error saving map. Please try again.');\r\n-    }\r\n-  }, [mapId, mapInfo]);\r\n-\r\n   return (\r\n     <div style={{ position: 'fixed', top: NAVBAR_HEIGHT, left: 0, width: '100vw', height: `calc(100vh - ${NAVBAR_HEIGHT}px)`, zIndex: 1 }}>\r\n       <MapContainer\r\n         center={[lat, lng]}\r\n         zoom={zoom}\r\n-        minZoom={2}\r\n-        maxZoom={18}\r\n+        minZoom={1}\r\n+        maxZoom={22}\r\n         style={{ width: '100%', height: '100%' }}\r\n         attributionControl={false}\r\n         zoomControl={true}\r\n         ref={(map) => {\r\n@@ -701,32 +737,42 @@\n             mapRef.current = map;\r\n           }\r\n         }}\r\n       >\r\n-        {/* Base tile layer */}\r\n-        <TileLayer \r\n-          url={TILE_LAYERS[currentLayers.baseMap as keyof typeof TILE_LAYERS]} \r\n-          attribution=\"¬© OpenStreetMap contributors\"\r\n-        />\r\n-        \r\n-        {/* Buildings overlay */}\r\n-        {currentLayers.buildings && (\r\n+        {/* Render map tiles based on current map type */}\r\n+        {currentMapType === 'hybrid' ? (\r\n+          <>\r\n+            {/* Hybrid: Satellite base + Road overlay */}\r\n+            <TileLayer \r\n+              url={TILE_LAYERS.hybrid.base}\r\n+              attribution={TILE_LAYERS.hybrid.attribution}\r\n+              maxZoom={TILE_LAYERS.hybrid.maxZoom}\r\n+            />\r\n+            <TileLayer \r\n+              url={TILE_LAYERS.hybrid.overlay}\r\n+              opacity={0.5}\r\n+              maxZoom={TILE_LAYERS.hybrid.maxZoom}\r\n+            />\r\n+          </>\r\n+        ) : currentMapType === 'traffic' ? (\r\n+          <>\r\n+            {/* Traffic: Road base (traffic overlay would need separate provider) */}\r\n+            <TileLayer \r\n+              url={TILE_LAYERS.traffic.base}\r\n+              attribution={TILE_LAYERS.traffic.attribution}\r\n+              maxZoom={TILE_LAYERS.traffic.maxZoom}\r\n+            />\r\n+            {/* Note: Real traffic data would require services like Google Maps Traffic API */}\r\n+          </>\r\n+        ) : (\r\n+          /* Standard map types: road, satellite, terrain */\r\n           <TileLayer \r\n-            url={OVERLAY_LAYERS.buildings}\r\n-            opacity={0.6}\r\n-            attribution=\"Buildings data\"\r\n+            url={TILE_LAYERS[currentMapType].url}\r\n+            attribution={TILE_LAYERS[currentMapType].attribution}\r\n+            maxZoom={TILE_LAYERS[currentMapType].maxZoom}\r\n           />\r\n         )}\r\n         \r\n-        {/* Street labels overlay */}\r\n-        {currentLayers.streets && (\r\n-          <TileLayer \r\n-            url={OVERLAY_LAYERS.streets}\r\n-            opacity={0.8}\r\n-            attribution=\"Street labels\"\r\n-          />\r\n-        )}\r\n-        \r\n         {/* Display all saved zones */}\r\n         <ZonesDisplay zones={zones} />\r\n       \r\n         {/* Show drawing controls only when actively drawing */}\r\n@@ -737,28 +783,25 @@\n             zoneName={currentZoneDetails.name}\r\n             zoneColor={currentZoneDetails.color}\r\n           />\r\n         )}\r\n+        \r\n+        {/* Track map bounds changes */}\r\n+        {onBoundsChange && <BoundsTracker onBoundsChange={onBoundsChange} />}\r\n       </MapContainer>\r\n \r\n       <ZoneControls\r\n         zones={zones}\r\n         isDrawing={isDrawing}\r\n         onCancelDrawing={handleCancelDrawing}\r\n         onCreateZone={handleStartDrawing}\r\n         onDeleteZone={handleDeleteZone}\r\n-        mapCode={mapInfo?.code}\r\n-        mapTitle={mapInfo?.title}\r\n         isSavingZone={isSavingZone}\r\n         onSaveAllZones={handleSaveAllZones}\r\n-        onSaveMap={handleSaveMap}\r\n+        currentMapType={currentMapType === 'traffic' ? 'road' : currentMapType}\r\n+        onMapTypeChange={handleMapTypeChange}\r\n       />\r\n       \r\n-      <LayerControls\r\n-        currentLayers={currentLayers}\r\n-        onLayerChange={handleLayerChange}\r\n-      />\r\n-      \r\n       <SaveMapButton \r\n         onClick={handleSaveAllZones} \r\n         isVisible={zones.length > 0 && !isDrawing && mapId !== undefined} \r\n         isSaving={isSavingZone}\r\n"
                },
                {
                    "date": 1761124126026,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -45,20 +45,20 @@\n const TILE_LAYERS = {\r\n   road: {\r\n     url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n     attribution: '¬© OpenStreetMap contributors',\r\n-    maxZoom: 19\r\n+    maxZoom: 22\r\n   },\r\n   satellite: {\r\n     url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n     attribution: '¬© Esri, Maxar, Earthstar Geographics',\r\n-    maxZoom: 19\r\n+    maxZoom: 22\r\n   },\r\n   hybrid: {\r\n     base: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n     overlay: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n     attribution: '¬© Esri, OpenStreetMap contributors',\r\n-    maxZoom: 19\r\n+    maxZoom: 22\r\n   },\r\n   terrain: {\r\n     url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',\r\n     attribution: '¬© OpenTopoMap contributors',\r\n@@ -66,9 +66,9 @@\n   },\r\n   traffic: {\r\n     base: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n     attribution: '¬© OpenStreetMap contributors',\r\n-    maxZoom: 19,\r\n+    maxZoom: 22,\r\n     note: 'Traffic overlay would require a specific traffic data provider'\r\n   }\r\n };\r\n \r\n"
                },
                {
                    "date": 1761124218881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -731,8 +731,11 @@\n         maxZoom={22}\r\n         style={{ width: '100%', height: '100%' }}\r\n         attributionControl={false}\r\n         zoomControl={true}\r\n+        scrollWheelZoom={true}\r\n+        doubleClickZoom={true}\r\n+        preferCanvas={false}\r\n         ref={(map) => {\r\n           if (map) {\r\n             mapRef.current = map;\r\n           }\r\n@@ -745,13 +748,15 @@\n             <TileLayer \r\n               url={TILE_LAYERS.hybrid.base}\r\n               attribution={TILE_LAYERS.hybrid.attribution}\r\n               maxZoom={TILE_LAYERS.hybrid.maxZoom}\r\n+              errorTileUrl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\"\r\n             />\r\n             <TileLayer \r\n               url={TILE_LAYERS.hybrid.overlay}\r\n               opacity={0.5}\r\n               maxZoom={TILE_LAYERS.hybrid.maxZoom}\r\n+              errorTileUrl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\"\r\n             />\r\n           </>\r\n         ) : currentMapType === 'traffic' ? (\r\n           <>\r\n@@ -759,8 +764,9 @@\n             <TileLayer \r\n               url={TILE_LAYERS.traffic.base}\r\n               attribution={TILE_LAYERS.traffic.attribution}\r\n               maxZoom={TILE_LAYERS.traffic.maxZoom}\r\n+              errorTileUrl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\"\r\n             />\r\n             {/* Note: Real traffic data would require services like Google Maps Traffic API */}\r\n           </>\r\n         ) : (\r\n@@ -768,8 +774,9 @@\n           <TileLayer \r\n             url={TILE_LAYERS[currentMapType].url}\r\n             attribution={TILE_LAYERS[currentMapType].attribution}\r\n             maxZoom={TILE_LAYERS[currentMapType].maxZoom}\r\n+            errorTileUrl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\"\r\n           />\r\n         )}\r\n         \r\n         {/* Display all saved zones */}\r\n"
                },
                {
                    "date": 1761129721556,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -38,8 +38,9 @@\n   onZoneCreated?: (zone: Zone) => void;\r\n   onBoundsChange?: (bounds: { north: number; south: number; east: number; west: number }) => void;\r\n   initialMapType?: 'road' | 'satellite' | 'hybrid' | 'terrain';\r\n   onMapTypeChange?: (type: 'road' | 'satellite' | 'hybrid' | 'terrain') => void;\r\n+  isViewOnly?: boolean; // New prop to disable editing for admin\r\n }\r\n \r\n // Different tile layer URLs - matching Google Maps style\r\n const TILE_LAYERS = {\r\n"
                },
                {
                    "date": 1761129735244,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,9 +246,10 @@\n   mapId,\r\n   onZoneCreated,\r\n   onBoundsChange,\r\n   initialMapType = 'road',\r\n-  onMapTypeChange\r\n+  onMapTypeChange,\r\n+  isViewOnly = false // Default to false for backward compatibility\r\n }) => {\r\n   const mapRef = useRef<L.Map | null>(null);\r\n   const [zones, setZones] = useState<Zone[]>([]);\r\n   const [isDrawing, setIsDrawing] = useState<boolean>(false);\r\n"
                },
                {
                    "date": 1761129746929,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -807,15 +807,19 @@\n         isSavingZone={isSavingZone}\r\n         onSaveAllZones={handleSaveAllZones}\r\n         currentMapType={currentMapType === 'traffic' ? 'road' : currentMapType}\r\n         onMapTypeChange={handleMapTypeChange}\r\n+        isViewOnly={isViewOnly} // Pass view-only mode to controls\r\n       />\r\n       \r\n-      <SaveMapButton \r\n-        onClick={handleSaveAllZones} \r\n-        isVisible={zones.length > 0 && !isDrawing && mapId !== undefined} \r\n-        isSaving={isSavingZone}\r\n-      />\r\n+      {/* Hide Save button in view-only mode */}\r\n+      {!isViewOnly && (\r\n+        <SaveMapButton \r\n+          onClick={handleSaveAllZones} \r\n+          isVisible={zones.length > 0 && !isDrawing && mapId !== undefined} \r\n+          isSaving={isSavingZone}\r\n+        />\r\n+      )}\r\n       \r\n       {highlightedCountry && (\r\n         <div style={{\r\n           position: 'absolute',\r\n"
                }
            ],
            "date": 1760434895630,
            "name": "Commit-0",
            "content": "import { MapContainer, TileLayer, useMap, Polygon, Tooltip } from 'react-leaflet';\r\nimport 'leaflet/dist/leaflet.css';\r\nimport 'leaflet-draw/dist/leaflet.draw.css';\r\nimport './WorldMap.css';\r\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport L from 'leaflet';\r\nimport 'leaflet-draw';\r\nimport { COUNTRY_COORDINATES } from '../utils/countryCoordinates';\r\nimport ZoneControls from './ZoneControls';\r\nimport LayerControls from './LayerControls';\r\nimport SaveMapButton from './SaveMapButton';\r\nimport './ZoneControls.css';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport type { Zone } from '../types/zones';\r\n\r\n// Fix for Leaflet marker icons in React\r\n// Using a more specific type for the prototype\r\ninterface LeafletIcon {\r\n  _getIconUrl?: unknown;\r\n}\r\n\r\n// Fix for Leaflet marker icons in React\r\ndelete (L.Icon.Default.prototype as LeafletIcon)._getIconUrl;\r\nL.Icon.Default.mergeOptions({\r\n  iconRetinaUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png',\r\n  iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',\r\n  shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',\r\n});\r\n\r\nconst NAVBAR_HEIGHT = 56;\r\n\r\ninterface WorldMapProps {\r\n  lat: number;\r\n  lng: number;\r\n  zoom: number;\r\n  highlightedCountry?: string;\r\n  initialZones?: Zone[];\r\n  mapId?: number;\r\n  onZoneCreated?: (zone: Zone) => void;\r\n}\r\n\r\n// Different tile layer URLs\r\nconst TILE_LAYERS = {\r\n  standard: 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',\r\n  satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n  terrain: 'https://tiles.stadiamaps.com/tiles/outdoors/{z}/{x}/{y}{r}.png',\r\n  dark: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png'\r\n};\r\n\r\n// Overlay layer URLs\r\nconst OVERLAY_LAYERS = {\r\n  buildings: 'https://tiles.openstreetmap.org/{z}/{x}/{y}.png', // Buildings overlay - better visibility\r\n  streets: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' // Street labels\r\n};\r\n\r\n// Display saved zones as polygons\r\nconst ZonesDisplay = ({ zones }: { zones: Zone[] }) => {\r\n  console.log('üó∫Ô∏è ZonesDisplay rendering with zones:', zones.length, zones);\r\n  \r\n  return (\r\n    <React.Fragment>\r\n      {zones.map((zone) => {\r\n        // Only render zones with coordinates\r\n        if (!zone.coordinates || zone.coordinates.length === 0) {\r\n          console.log('‚ö†Ô∏è Skipping zone with no coordinates:', zone.name);\r\n          return null;\r\n        }\r\n        \r\n        console.log(`üé® Rendering zone: ${zone.name} (${zone.color}) with ${zone.coordinates.length} coordinates`);\r\n        \r\n        return (\r\n          <Polygon \r\n            key={zone.id} \r\n            positions={zone.coordinates}\r\n            pathOptions={{ color: zone.color, fillColor: zone.color, fillOpacity: 0.3 }}\r\n          >\r\n            <Tooltip permanent>\r\n              {zone.name}\r\n            </Tooltip>\r\n          </Polygon>\r\n        );\r\n      })}\r\n    </React.Fragment>\r\n  );\r\n};\r\n\r\n// Separate component to use the useMap hook\r\nconst PolygonDrawingControl = ({ \r\n  onZoneCreated, \r\n  isDrawing, \r\n  zoneName, \r\n  zoneColor \r\n}: { \r\n  onZoneCreated: (zone: Zone) => void;\r\n  isDrawing: boolean; \r\n  zoneName: string; \r\n  zoneColor: string \r\n}) => {\r\n  const map = useMap();\r\n  const drawingLayerRef = useRef<L.FeatureGroup | null>(null);\r\n  \r\n  // Initialize the drawing layer\r\n  useEffect(() => {\r\n    // Create a FeatureGroup to store editable layers\r\n    const drawingLayer = new L.FeatureGroup();\r\n    map.addLayer(drawingLayer);\r\n    drawingLayerRef.current = drawingLayer;\r\n    \r\n    // Handle created polygon\r\n    const handleCreated = (e: L.LeafletEvent) => {\r\n      // Cast the event to access draw event properties\r\n      const drawEvent = e as unknown as { layer: L.Polygon; layerType: string };\r\n      const layer = drawEvent.layer;\r\n      \r\n      // Extract coordinates from the layer FIRST\r\n      const coords: [number, number][] = [];\r\n      if (layer.getLatLngs && typeof layer.getLatLngs === 'function') {\r\n        // For polygons, getLatLngs returns an array of arrays\r\n        const latLngGroups = layer.getLatLngs() as L.LatLng[][] | L.LatLng[][][];\r\n        const firstRing = Array.isArray(latLngGroups[0]) ? latLngGroups[0] as L.LatLng[] : latLngGroups as unknown as L.LatLng[];\r\n        for (const latLng of firstRing) {\r\n          coords.push([latLng.lat, latLng.lng]);\r\n        }\r\n      }\r\n      \r\n      console.log('üéØ Zone drawn with coordinates:', coords);\r\n      \r\n      // Don't add the layer to the drawing layer - let ZonesDisplay handle it\r\n      // The drawing layer is just for temporary drawing, not for permanent display\r\n      \r\n      // Create the zone object with coordinates\r\n      const newZone: Zone = {\r\n        id: uuidv4(),\r\n        name: zoneName,\r\n        color: zoneColor,\r\n        coordinates: coords\r\n      };\r\n      \r\n      // Notify parent component (this should end the drawing state)\r\n      onZoneCreated(newZone);\r\n    };\r\n    \r\n    // Add the event listener\r\n    map.on('draw:created', handleCreated);\r\n    \r\n    // Cleanup\r\n    return () => {\r\n      map.off('draw:created', handleCreated);\r\n      if (drawingLayerRef.current && map.hasLayer(drawingLayerRef.current)) {\r\n        map.removeLayer(drawingLayerRef.current);\r\n      }\r\n    };\r\n  }, [map, zoneName, zoneColor, onZoneCreated]);\r\n  \r\n  // Enable/disable drawing\r\n  useEffect(() => {\r\n    if (!map) return;\r\n    \r\n    if (isDrawing) {\r\n      try {\r\n        // Create a proper type for L.Draw.Polygon \r\n        interface DrawOptions {\r\n          shapeOptions?: L.PathOptions;\r\n        }\r\n        \r\n        interface DrawPolygonStatic {\r\n          new(map: L.Map, options?: DrawOptions): L.Draw.Polygon;\r\n        }\r\n        \r\n        const DrawPolygon = L.Draw.Polygon as unknown as DrawPolygonStatic;\r\n        const drawControl = new DrawPolygon(map, {\r\n          shapeOptions: {\r\n            color: zoneColor,\r\n            fillColor: zoneColor,\r\n            fillOpacity: 0.3\r\n          }\r\n        });\r\n        drawControl.enable();\r\n        \r\n        // Cancel drawing when the isDrawing state changes\r\n        return () => {\r\n          drawControl.disable();\r\n        };\r\n      } catch (error) {\r\n        console.error('Error creating draw control:', error);\r\n      }\r\n    }\r\n  }, [map, isDrawing, zoneColor]);\r\n  \r\n  return null;\r\n};\r\n\r\nconst WorldMap: React.FC<WorldMapProps> = ({\r\n  lat,\r\n  lng,\r\n  zoom,\r\n  highlightedCountry,\r\n  initialZones = [],\r\n  mapId,\r\n  onZoneCreated\r\n}) => {\r\n  const mapRef = useRef<L.Map | null>(null);\r\n  const [zones, setZones] = useState<Zone[]>(initialZones);\r\n  const [isDrawing, setIsDrawing] = useState<boolean>(false);\r\n  const [currentZoneDetails, setCurrentZoneDetails] = useState<{ name: string; color: string }>({ name: \"\", color: \"#3388ff\" });\r\n  const [mapInfo, setMapInfo] = useState<{ code: string; title: string } | null>(null);\r\n  const [isSavingZone, setIsSavingZone] = useState<boolean>(false);\r\n  \r\n  // Layer management state\r\n  const [currentLayers, setCurrentLayers] = useState({\r\n    baseMap: 'standard',\r\n    buildings: false,\r\n    streets: false\r\n  });\r\n  \r\n  // Generate map code for new maps\r\n  const generateMapCode = useCallback((): string => {\r\n    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\r\n    let result = 'MAP-';\r\n    \r\n    for (let i = 0; i < 4; i++) {\r\n      result += characters.charAt(Math.floor(Math.random() * characters.length));\r\n    }\r\n    \r\n    result += '-';\r\n    \r\n    for (let i = 0; i < 4; i++) {\r\n      result += characters.charAt(Math.floor(Math.random() * characters.length));\r\n    }\r\n    \r\n    return result;\r\n  }, []);\r\n  \r\n  // Generate map code on mount if no mapId exists\r\n  useEffect(() => {\r\n    if (!mapId && !mapInfo) {\r\n      const newCode = generateMapCode();\r\n      console.log('üîñ Generated new map code for unsaved map:', newCode);\r\n      setMapInfo({\r\n        code: newCode,\r\n        title: 'New Map'\r\n      });\r\n    }\r\n  }, [mapId, mapInfo, generateMapCode]);\r\n\r\n  // Initialize zones when initialZones prop changes\r\n  useEffect(() => {\r\n    setZones(initialZones);\r\n  }, [initialZones]);\r\n\r\n  // Load zones from database when mapId changes\r\n  useEffect(() => {\r\n    const loadZones = async () => {\r\n      console.log('üîç WorldMap loadZones effect triggered, mapId:', mapId);\r\n      \r\n      if (!mapId) {\r\n        console.log('‚ùå No mapId provided, skipping zone loading');\r\n        return;\r\n      }\r\n      \r\n      try {\r\n        console.log(`üåê Loading zones for map ID: ${mapId}`);\r\n        const response = await fetch(`/api/db/tables/zones?map_id=${mapId}`);\r\n        const data = await response.json();\r\n        \r\n        console.log('üìä Zones API response:', data);\r\n        \r\n        if (data.success && Array.isArray(data.records)) {\r\n          // Parse coordinates from JSON strings\r\n          const zonesWithParsedCoords = data.records.map((zone: Zone & { coordinates: string | [number, number][] }) => ({\r\n            ...zone,\r\n            coordinates: typeof zone.coordinates === 'string' \r\n              ? JSON.parse(zone.coordinates) \r\n              : zone.coordinates\r\n          }));\r\n          \r\n          setZones(zonesWithParsedCoords);\r\n          console.log(`‚úÖ Loaded ${zonesWithParsedCoords.length} zones for map ${mapId}:`, zonesWithParsedCoords);\r\n        } else {\r\n          console.log('‚ö†Ô∏è No zones found for this map');\r\n          setZones([]);\r\n        }\r\n      } catch (err) {\r\n        console.error('‚ùå Failed to load zones:', err);\r\n        setZones([]);\r\n      }\r\n    };\r\n    \r\n    loadZones();\r\n  }, [mapId]);\r\n\r\n  // Load map information when mapId changes\r\n  useEffect(() => {\r\n    const loadMapInfo = async () => {\r\n      if (!mapId) {\r\n        setMapInfo(null);\r\n        return;\r\n      }\r\n      \r\n      try {\r\n        const response = await fetch(`/api/db/tables/map/${mapId}`);\r\n        const data = await response.json();\r\n        \r\n        if (data.success && data.record) {\r\n          const mapCode = data.record.map_code || `MAP-${mapId}`;\r\n          \r\n          setMapInfo({\r\n            code: mapCode,\r\n            title: data.record.title || 'Untitled Map'\r\n          });\r\n        }\r\n      } catch (err) {\r\n        console.error('Failed to load map info:', err);\r\n        setMapInfo(null);\r\n      }\r\n    };\r\n    \r\n    loadMapInfo();\r\n  }, [mapId]);\r\n\r\n  // Update map view when highlighted country changes\r\n  useEffect(() => {\r\n    if (highlightedCountry && COUNTRY_COORDINATES[highlightedCountry] && mapRef.current) {\r\n      const { lat: countryLat, lng: countryLng, zoom: countryZoom } = COUNTRY_COORDINATES[highlightedCountry];\r\n      mapRef.current.setView([countryLat, countryLng], countryZoom, { animate: true });\r\n    }\r\n  }, [highlightedCountry]);\r\n\r\n  // Update map when lat/lng/zoom changes\r\n  useEffect(() => {\r\n    if (mapRef.current && lat && lng) {\r\n      mapRef.current.setView([lat, lng], zoom, { animate: true });\r\n    }\r\n  }, [lat, lng, zoom]);\r\n\r\n  // Handle starting to draw a zone\r\n  const handleStartDrawing = useCallback((name: string, color: string) => {\r\n    if (!name.trim()) {\r\n      alert(\"Please enter a zone name\");\r\n      return;\r\n    }\r\n    \r\n    console.log(`üé® Starting to draw zone: ${name} (${color})`);\r\n    setIsDrawing(true);\r\n    setCurrentZoneDetails({ name, color });\r\n  }, []);\r\n\r\n  const handleCancelDrawing = useCallback(() => {\r\n    console.log('‚ùå Cancelled zone drawing');\r\n    setIsDrawing(false);\r\n  }, []);\r\n\r\n  // Handle zone creation callback from PolygonDrawingControl\r\n  const handleZoneCreated = useCallback(async (zoneData: Zone) => {\r\n    console.log('üíæ Zone created, processing...', zoneData);\r\n    \r\n    // Add to local state IMMEDIATELY for visual feedback\r\n    setZones(prev => [...prev, zoneData]);\r\n    \r\n    // End drawing state immediately\r\n    setIsDrawing(false);\r\n    \r\n    // If external handler is provided (like from CreateMapPage), use it\r\n    if (onZoneCreated) {\r\n      console.log('üì§ Delegating zone creation to external handler');\r\n      onZoneCreated(zoneData);\r\n      return;\r\n    }\r\n    \r\n    setIsSavingZone(true);\r\n    try {\r\n      // Save zone to database first with proper customer linking\r\n      if (mapId) {\r\n        // First get the map owner to set customer_id\r\n        const mapResponse = await fetch(`/api/db/tables/map/${mapId}`);\r\n        const mapData = await mapResponse.json();\r\n        \r\n        let customer_id = null;\r\n        if (mapData.success && mapData.record) {\r\n          customer_id = mapData.record.customer_id;\r\n        }\r\n        \r\n        console.log('üè™ Saving zone with customer_id:', customer_id);\r\n        \r\n        // Save to zones table with customer_id\r\n        const response = await fetch('/api/db/tables/zones', {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            id: zoneData.id,\r\n            map_id: mapId,\r\n            customer_id: customer_id,\r\n            name: zoneData.name,\r\n            color: zoneData.color,\r\n            coordinates: JSON.stringify(zoneData.coordinates)\r\n          })\r\n        });\r\n        \r\n        const result = await response.json();\r\n        if (result.success) {\r\n          console.log('‚úÖ Zone saved successfully:', result);\r\n          // Zone already added to local state above\r\n          \r\n          // Show success message without blocking the UI\r\n          setTimeout(() => {\r\n            const successMsg = document.createElement('div');\r\n            successMsg.innerHTML = `\r\n              <div style=\"\r\n                position: fixed;\r\n                bottom: 20px;\r\n                right: 20px;\r\n                background-color: #28a745;\r\n                color: white;\r\n                padding: 15px 20px;\r\n                border-radius: 5px;\r\n                box-shadow: 0 2px 10px rgba(0,0,0,0.2);\r\n                z-index: 2000;\r\n                animation: fadeIn 0.5s, fadeOut 0.5s 3.5s forwards;\r\n                display: flex;\r\n                align-items: center;\r\n                gap: 10px;\r\n              \">\r\n                <span style=\"font-size: 20px;\">‚úÖ</span>\r\n                <div>\r\n                  <strong>Success!</strong><br>\r\n                  Zone \"${zoneData.name}\" saved to database\r\n                </div>\r\n              </div>\r\n              <style>\r\n                @keyframes fadeIn {\r\n                  from { opacity: 0; transform: translateY(20px); }\r\n                  to { opacity: 1; transform: translateY(0); }\r\n                }\r\n                @keyframes fadeOut {\r\n                  from { opacity: 1; transform: translateY(0); }\r\n                  to { opacity: 0; transform: translateY(-20px); }\r\n                }\r\n              </style>\r\n            `;\r\n            document.body.appendChild(successMsg);\r\n            \r\n            // Remove notification after 4 seconds\r\n            setTimeout(() => {\r\n              document.body.removeChild(successMsg);\r\n            }, 4000);\r\n          }, 100);\r\n        } else {\r\n          console.error('‚ùå Failed to save zone:', result.error);\r\n          alert('Failed to save zone: ' + result.error);\r\n        }\r\n      } else {\r\n        console.warn('‚ö†Ô∏è No mapId provided, zone not saved to database');\r\n        // Zone already added to local state above\r\n        alert(`Zone \"${zoneData.name}\" created locally (not saved to database)`);\r\n      }\r\n    } catch (err) {\r\n      console.error('‚ùå Failed to save zone:', err);\r\n      // Zone already added to local state above\r\n      alert('Zone created but failed to save to database. Please try again later.');\r\n    } finally {\r\n      setIsSavingZone(false);\r\n    }\r\n  }, [mapId, onZoneCreated]);\r\n\r\n  // Handle deleting a zone\r\n  const handleDeleteZone = useCallback(async (id: string) => {\r\n    console.log('üóëÔ∏è Deleting zone:', id);\r\n    \r\n    try {\r\n      // Delete from database first\r\n      const response = await fetch(`/api/db/tables/zones/${id}`, {\r\n        method: 'DELETE'\r\n      });\r\n      \r\n      const result = await response.json();\r\n      if (result.success) {\r\n        // Remove from local state\r\n        setZones(prev => prev.filter(z => z.id !== id));\r\n        console.log('‚úÖ Zone deleted successfully');\r\n      } else {\r\n        console.error('‚ùå Failed to delete zone:', result.error);\r\n        alert('Failed to delete zone: ' + result.error);\r\n      }\r\n    } catch (err) {\r\n      console.error('‚ùå Failed to delete zone:', err);\r\n      alert('Failed to delete zone. Please try again.');\r\n    }\r\n  }, []);\r\n\r\n  // Handle layer changes\r\n  const handleLayerChange = useCallback((layerType: string, value: string | boolean) => {\r\n    setCurrentLayers(prev => ({\r\n      ...prev,\r\n      [layerType]: value\r\n    }));\r\n  }, []);\r\n\r\n  // Handle saving all zones (manual save)\r\n  const handleSaveAllZones = useCallback(async () => {\r\n    console.log('üíæ Manually saving all zones to database...', zones.length);\r\n    \r\n    if (zones.length === 0) {\r\n      alert('No zones to save.');\r\n      return;\r\n    }\r\n\r\n    setIsSavingZone(true);\r\n    try {\r\n      let successCount = 0;\r\n      let errorCount = 0;\r\n\r\n      for (const zone of zones) {\r\n        try {\r\n          const response = await fetch(`/api/db/tables/zones/${zone.id}`, {\r\n            method: 'PUT',\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({\r\n              name: zone.name,\r\n              color: zone.color,\r\n              coordinates: zone.coordinates,\r\n              map_id: mapId,\r\n            })\r\n          });\r\n\r\n          const result = await response.json();\r\n          if (result.success) {\r\n            successCount++;\r\n          } else {\r\n            errorCount++;\r\n            console.error('‚ùå Failed to save zone:', zone.id, result.error);\r\n          }\r\n        } catch (err) {\r\n          errorCount++;\r\n          console.error('‚ùå Error saving zone:', zone.id, err);\r\n        }\r\n      }\r\n\r\n      // Create a fancy notification instead of alert\r\n      const notificationDiv = document.createElement('div');\r\n      if (errorCount === 0) {\r\n        notificationDiv.innerHTML = `\r\n          <div style=\"\r\n            position: fixed;\r\n            top: 80px;\r\n            left: 50%;\r\n            transform: translateX(-50%);\r\n            background-color: #28a745;\r\n            color: white;\r\n            padding: 15px 25px;\r\n            border-radius: 8px;\r\n            box-shadow: 0 4px 15px rgba(0,0,0,0.3);\r\n            z-index: 2000;\r\n            animation: fadeInOut 4s forwards;\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 12px;\r\n            font-size: 16px;\r\n          \">\r\n            <span style=\"font-size: 24px;\">‚úÖ</span>\r\n            <div>\r\n              <strong>Success!</strong><br>\r\n              All ${successCount} zones saved to database\r\n            </div>\r\n          </div>\r\n          <style>\r\n            @keyframes fadeInOut {\r\n              0% { opacity: 0; transform: translate(-50%, -20px); }\r\n              10% { opacity: 1; transform: translate(-50%, 0); }\r\n              80% { opacity: 1; transform: translate(-50%, 0); }\r\n              100% { opacity: 0; transform: translate(-50%, -20px); }\r\n            }\r\n          </style>\r\n        `;\r\n      } else {\r\n        notificationDiv.innerHTML = `\r\n          <div style=\"\r\n            position: fixed;\r\n            top: 80px;\r\n            left: 50%;\r\n            transform: translateX(-50%);\r\n            background-color: #ffc107;\r\n            color: #333;\r\n            padding: 15px 25px;\r\n            border-radius: 8px;\r\n            box-shadow: 0 4px 15px rgba(0,0,0,0.2);\r\n            z-index: 2000;\r\n            animation: fadeInOut 5s forwards;\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 12px;\r\n            font-size: 16px;\r\n          \">\r\n            <span style=\"font-size: 24px;\">‚ö†Ô∏è</span>\r\n            <div>\r\n              <strong>Partial Success</strong><br>\r\n              Saved ${successCount} zones, ${errorCount} failed.<br>\r\n              <small>Check console for details.</small>\r\n            </div>\r\n          </div>\r\n          <style>\r\n            @keyframes fadeInOut {\r\n              0% { opacity: 0; transform: translate(-50%, -20px); }\r\n              10% { opacity: 1; transform: translate(-50%, 0); }\r\n              80% { opacity: 1; transform: translate(-50%, 0); }\r\n              100% { opacity: 0; transform: translate(-50%, -20px); }\r\n            }\r\n          </style>\r\n        `;\r\n      }\r\n      \r\n      document.body.appendChild(notificationDiv);\r\n      \r\n      // Remove notification after animation completes\r\n      setTimeout(() => {\r\n        if (document.body.contains(notificationDiv)) {\r\n          document.body.removeChild(notificationDiv);\r\n        }\r\n      }, 5000);\r\n    } catch (err) {\r\n      console.error('‚ùå Error during bulk save:', err);\r\n      alert('Error saving zones. Please try again.');\r\n    } finally {\r\n      setIsSavingZone(false);\r\n    }\r\n  }, [zones, mapId]);\r\n\r\n  // Handle saving map data\r\n  const handleSaveMap = useCallback(async () => {\r\n    console.log('üíæ Saving map data...', mapInfo);\r\n    \r\n    if (!mapId || !mapInfo) {\r\n      alert('No map data to save.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`/api/db/tables/map/${mapId}`, {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          title: mapInfo.title,\r\n          code: mapInfo.code,\r\n        })\r\n      });\r\n\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        alert('‚úÖ Map saved successfully!');\r\n      } else {\r\n        console.error('‚ùå Failed to save map:', result.error);\r\n        alert('Failed to save map: ' + result.error);\r\n      }\r\n    } catch (err) {\r\n      console.error('‚ùå Error saving map:', err);\r\n      alert('Error saving map. Please try again.');\r\n    }\r\n  }, [mapId, mapInfo]);\r\n\r\n  return (\r\n    <div style={{ position: 'fixed', top: NAVBAR_HEIGHT, left: 0, width: '100vw', height: `calc(100vh - ${NAVBAR_HEIGHT}px)`, zIndex: 1 }}>\r\n      <MapContainer\r\n        center={[lat, lng]}\r\n        zoom={zoom}\r\n        minZoom={2}\r\n        maxZoom={18}\r\n        style={{ width: '100%', height: '100%' }}\r\n        attributionControl={false}\r\n        zoomControl={true}\r\n        ref={(map) => {\r\n          if (map) {\r\n            mapRef.current = map;\r\n          }\r\n        }}\r\n      >\r\n        {/* Base tile layer */}\r\n        <TileLayer \r\n          url={TILE_LAYERS[currentLayers.baseMap as keyof typeof TILE_LAYERS]} \r\n          attribution=\"¬© OpenStreetMap contributors\"\r\n        />\r\n        \r\n        {/* Buildings overlay */}\r\n        {currentLayers.buildings && (\r\n          <TileLayer \r\n            url={OVERLAY_LAYERS.buildings}\r\n            opacity={0.6}\r\n            attribution=\"Buildings data\"\r\n          />\r\n        )}\r\n        \r\n        {/* Street labels overlay */}\r\n        {currentLayers.streets && (\r\n          <TileLayer \r\n            url={OVERLAY_LAYERS.streets}\r\n            opacity={0.8}\r\n            attribution=\"Street labels\"\r\n          />\r\n        )}\r\n        \r\n        {/* Display all saved zones */}\r\n        <ZonesDisplay zones={zones} />\r\n      \r\n        {/* Show drawing controls only when actively drawing */}\r\n        {isDrawing && (\r\n          <PolygonDrawingControl \r\n            onZoneCreated={handleZoneCreated}\r\n            isDrawing={isDrawing}\r\n            zoneName={currentZoneDetails.name}\r\n            zoneColor={currentZoneDetails.color}\r\n          />\r\n        )}\r\n      </MapContainer>\r\n\r\n      <ZoneControls\r\n        zones={zones}\r\n        isDrawing={isDrawing}\r\n        onCancelDrawing={handleCancelDrawing}\r\n        onCreateZone={handleStartDrawing}\r\n        onDeleteZone={handleDeleteZone}\r\n        mapCode={mapInfo?.code}\r\n        mapTitle={mapInfo?.title}\r\n        isSavingZone={isSavingZone}\r\n        onSaveAllZones={handleSaveAllZones}\r\n        onSaveMap={handleSaveMap}\r\n      />\r\n      \r\n      <LayerControls\r\n        currentLayers={currentLayers}\r\n        onLayerChange={handleLayerChange}\r\n      />\r\n      \r\n      <SaveMapButton \r\n        onClick={handleSaveAllZones} \r\n        isVisible={zones.length > 0 && !isDrawing && mapId !== undefined} \r\n        isSaving={isSavingZone}\r\n      />\r\n      \r\n      {highlightedCountry && (\r\n        <div style={{\r\n          position: 'absolute',\r\n          top: '20px',\r\n          left: '50%',\r\n          transform: 'translateX(-50%)',\r\n          backgroundColor: 'rgba(255,255,255,0.9)',\r\n          padding: '8px 16px',\r\n          borderRadius: '20px',\r\n          boxShadow: '0 2px 10px rgba(0,0,0,0.2)',\r\n          zIndex: 1000,\r\n          pointerEvents: 'none',\r\n          fontSize: '16px',\r\n          fontWeight: 'bold',\r\n          color: '#4f8cff'\r\n        }}>\r\n          {highlightedCountry}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default WorldMap;"
        }
    ]
}